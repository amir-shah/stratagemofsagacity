version: '3.8'

services:
  # Development environment with Godot editor
  dev:
    build:
      context: .
      target: dev
      dockerfile: Dockerfile
    volumes:
      - .:/app
      - godot-cache:/root/.cache/godot
      - godot-config:/root/.config/godot
    environment:
      - DISPLAY=${DISPLAY:-:0}
    network_mode: host
    stdin_open: true
    tty: true
    command: /bin/bash

  # Build the game (exports to build/ folder)
  build:
    build:
      context: .
      target: build
      dockerfile: Dockerfile
    volumes:
      - .:/app
      - ./build:/app/build
    command: /bin/bash -c "echo 'Build complete. Check ./build/ folder for exports.'"

  # Run the game (runtime)
  game:
    build:
      context: .
      target: runtime
      dockerfile: Dockerfile
    volumes:
      - .:/app
    environment:
      - DISPLAY=${DISPLAY:-:0}
    network_mode: host
    stdin_open: true
    tty: true

  # Web server for HTML5 build
  web:
    image: python:3.11-slim
    volumes:
      - ./build/web:/web
    working_dir: /web
    ports:
      - "8000:8000"
    command: python -m http.server 8000
    depends_on:
      - build

volumes:
  godot-cache:
  godot-config:
